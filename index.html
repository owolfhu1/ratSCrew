<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <style>

        .chat{  position: absolute;  top: 0;  right: 0;  z-index: 1;  width: 30%;  }
        .chat_body{  width: 100%; height: 100px; background: whitesmoke;
            border: dashed purple; overflow-y: scroll; }
        .chat_input{ width: 100%; top: 100px; }
        .slap_image {  position: absolute;  top: 30%;  left: 40%;  margin-top: -50px;  margin-left: -50px;  }
        .slap_info_content {  margin: auto;  padding: 5px;  background-color: transparent;
            width: 100%;  height: 100%;  color: #f51300; }
        .slap_info{  display: none;  position: absolute;  z-index: 1;  width: 100%;  height: 100%;
            top: 0;  right: 0;  overflow: hidden;  }
        .turn_text{  position: absolute;  bottom: 0;  left: 0;  }
        .player_info{  position: absolute;  bottom: 0;  right: 0;  }
        .game_body{  width: 100%;  height: 100%;  }
        .player_pile{  text-align: center;  position: absolute;  border: solid;  height: 20%;  }
        .play_pile{  width: 120px;  height: 180px;  position: absolute;  top: 37%;  left: 50%;
            margin-top: -50px;  margin-left: -50px;  border: dashed green;  border-radius: 20px;  }â€‹

    </style>
</head>
<body>
    <div id="slap_info" class="slap_info">
        <div id="slap_info_content" class="slap_info_content">
        </div>
    </div>
    <div id="chat" class="chat">
        <div id="chat_body" class="chat_body">

            <p>this is a long paraghragh that i will use to teest if the lines overlap</p>
            <p>this is a long paraghragh that i will use to teest if the lines overlap</p>
            <p>this is a long paraghragh that i will use to teest if the lines overlap</p>

        </div>
        <input title="chat_input" id="chat_input" class="chat_input"/>
    </div>
    <div class="game_body" id="game_body">

       <!--  test area  -->



    </div>
<script>
    const SLAP = new Audio('http://owolfhu1.x10host.com/Oh_Hell_solo/img/slap.mp3');
    const alertSound = new Audio('http://owolfhu1.x10host.com/Oh_Hell_solo/img/sound.mp3');
    let game_body = document.getElementById('game_body');
    let socket = io();
    let playerNumber, player1, player2, player3, player4, play_pile,
        turn_text, slap_info, slap_info_content, player_info, rules, players,  chat_body, chat_input, name = 'GUEST';
    slap_info = document.getElementById('slap_info');
    slap_info_content = document.getElementById('slap_info_content');
    chat_body = document.getElementById('chat_body');
    chat_input = document.getElementById('chat_input');

    //send chat to server on enter key press
    chat_input.addEventListener("keyup", function(event) {
        event.preventDefault();
        if (event.keyCode === 13) {
            let text = chat_input.value;
            chat_input.value = '';
            socket.emit('chat', `<p>${name}: ${text}</p>`);
        }
    });

    //get name from server when you log in
    socket.on('set_name', x => {name = x;});

    //display chat from server
    socket.on('chat', text => {
        chat_body.innerHTML += text;
        chat_body.scrollTop = chat_body.scrollHeight;
    });

    socket.on('setup_login', () => {
        //setup game_body to have login fields
        game_body.innerHTML = `
            <input id="user_name" type="text" value="Please enter a username"><br>
            <input id="password" type="password"><br>
            <button id="login_button">login</button>
        `;
        //activate button to send login emit
        document.getElementById('login_button').addEventListener('click', () => {
            let password = document.getElementById('password').value;
            let user_name = document.getElementById('user_name').value;
            socket.emit('login', [user_name, password]);
        });
    });

    //server to console messages
    socket.on('login', text => {
       console.log(text);
    });

    socket.on('clear_game', () => {
        console.log('clear game attempted');
        play_pile.innerHTML = '';
    });

    socket.on('slap', info => {



        //play slap sound
        SLAP.play();














        //show slap divs
        slap_info.style.display = 'block';
        //display info from server
        slap_info_content.innerHTML = info[0];
        if (info[1])
            slap_info_content.innerHTML += `
<image class="slap_image" src="http://owolfhu1.x10host.com/Oh_Hell_solo/img/slap.png"/>`;


        //on click hide slap divs again
        slap_info_content.addEventListener('click', () => {
            slap_info.style.display = 'none';
        });

    });

    socket.on('lobby', tables => {
        let body = `<button id="new_table" class="table_button"><br><p>new table</p><br></button>`;
        //for each table, build a button w/ players names and
        for (let tableId in tables) {
            let table = tables[tableId];
            //building table button
            let button = `<button class="table_button" id="${tableId}">`;
            for (let i = 1; i < 5; i++) {
                let p = 'player' + i;
                if (table[p] !== null)
                    button += `<p>${table[p].name}</p>`;
            }
            button += `</button>`;
            //add the button to the game_body
            body += button;
        }
        //update the html
        game_body.innerHTML = body;
        //activate table buttons
        for (let tableId in tables)
            document.getElementById(tableId).addEventListener('click', () => {
                //attempt to join table
                socket.emit('join_table', tableId);
            });
        document.getElementById('new_table').addEventListener('click', () => {
            socket.emit('join_table', 'new');
        });
    });

    socket.on('setup_table', player => {
        //get playerNumber
        if (player !== null)
            playerNumber = player;
        game_body.innerHTML = `
        <div id="players"></div>
        <form id="rules">
            <h1>slap conditions:</h1>
            sandwiches:
            <input type="radio" title="sandwich" name="sandwich" id="sandwichon" value="on" checked>on
            <input type="radio" title="sandwich" name="sandwich" id="sandwichoff" value="off">off <br>
            doubles:
            <input type="radio" title="double" name="double" id="doubleon" value="on" checked>on
            <input type="radio" title="double" name="double" id="doubleoff" value="off">off <br>
            adds to 10:
            <input type="radio" title="sumten" name="sumten" id="sumtenon" value="on" checked>on
            <input type="radio" title="sumten" name="sumten" id="sumtenoff" value="off">off <br>
            runs:
            <input type="radio" title="run" name="run" id="runoff" value="off">off
            <input type="radio" title="run" name="run" id="runtwo" value="two" checked>two
            <input type="radio" title="run" name="run" id="runthree" value="three">three
            <input type="radio" title="run" name="run" id="runfour" value="four">four <br>
            bottom = top:
            <input type="radio" title="bottomTop" name="bottomTop" id="bottomTopon" value="on" checked>on
            <input type="radio" title="bottomTop" name="bottomTop" id="bottomTopoff" value="off">off
            <h1>other rules:</h1>
            jokers (can be slapped):
            <input type="radio" title="jokers" name="jokers" id="jokerson" value="on" checked>on
            <input type="radio" title="jokers" name="jokers" id="jokersoff" value="off">off <br>
            <div style="display: none">
            punishment for slapping:
            <input type="radio" title="punish" name="punish" id="punishoff" value="off">off
            <input type="radio" title="punish" name="punish" id="punishone" value="one" checked>one card
            <input type="radio" title="punish" name="punish" id="punishtwo" value="two">two cards <br>
            </div>
            timeout for slapping without cards: <br>
            <input type="radio" title="timeout" name="timeout" id="timeoutoff" value="off">off
            <input type="radio" title="timeout" name="timeout" id="timeouttwo" value="two" checked>two minutes
            <input type="radio" title="timeout" name="timeout" id="timeoutfive" value="five">five minutes
            <input type="radio" title="timeout" name="timeout" id="timeoutforever" value="forever">forever<br>
        </form>
        `;
        rules = document.getElementById('rules');
        players = document.getElementById('players');
    });

    socket.on('table', table => {
        //make rules form
        players.innerHTML = '';
        //adds html for all players at table
        for (let i = 1; i < 5; i++) {
            let p = 'player' + i;
            //for all non-null players
            if (table[p] !== null) {
                //if it is the player, give them a ready button
                if (p === playerNumber) {
                    players.innerHTML += `
<h2>${table[p].name} <button id="ready_button">${table[p].ready}</button></h2>`;
                } else {
                    //else just display name and if they are ready
                    players.innerHTML += `
<h2> ${table[p].name} ${table[p].ready} </h2>`;
                }
            }
        }
        //activate button
        let ready_button = document.getElementById('ready_button');
        ready_button.addEventListener('click', () => {
            console.log('player hit ready button' + playerNumber); //for testing remove later
            socket.emit('ready', playerNumber);
        });

        console.log(table);
        for (let key in table){
            let p ='player';
            if (!(key === p + 1 || key === p + 2 || key === p + 3 || key === p + 4)) {
                document.getElementById(key + table[key]).checked = true;
            }
        }

        $("#rules").on("change", function() {
            let emit = [
                rules.sandwich.value,   //0
                rules.run.value,        //1
                rules.bottomTop.value,  //2
                rules.jokers.value,     //3
                rules.punish.value,     //4
                rules.timeout.value,    //5
                rules.double.value,     //6
                rules.sumten.value      //7
            ];
            socket.emit('rules', emit);
        });

    });

    socket.on('setup_game', () => {
        game_body.innerHTML = `
            <div class="turn_text" id="turn_text"></div>
            <div class="player_info" id="player_info"></div>
            <div class="player_pile" id="player1"></div>
            <div class="player_pile" id="player2"></div>
            <div class="player_pile" id="player3"></div>
            <div class="player_pile" id="player4"></div>
            <div class="play_pile" id="play_pile"></div>
        `;
        //get doc elements
        player1 = document.getElementById('player1');
        player2 = document.getElementById('player2');
        player3 = document.getElementById('player3');
        player4 = document.getElementById('player4');
        play_pile = document.getElementById('play_pile');
        turn_text = document.getElementById('turn_text');
        player_info = document.getElementById('player_info');
        //add slap event listener
        play_pile.addEventListener('mousedown', () =>{
            socket.emit('slap');
        });
        //position player_pile divs
        if (playerNumber === 'player1') {
            player1.style = `bottom: 0px; left: 50%; margin-left: -50px;`;
            player2.style = `bottom: 50%; left: 0px; margin-top: -50px;`;
            player3.style = `top: 0px; left: 50%; margin-left: -50px;`;
            player4.style = `bottom: 50%; right: 0px; margin-top: -50px;`;
        } else if (playerNumber === 'player2') {
            player2.style = `bottom: 0px; left: 50%; margin-left: -50px;`;
            player3.style = `bottom: 50%; left: 0px; margin-top: -50px;`;
            player4.style = `top: 0px; left: 50%; margin-left: -50px;`;
            player1.style = `bottom: 50%; right: 0px; margin-top: -50px;`;
        } else if (playerNumber === 'player3') {
            player3.style = `bottom: 0px; left: 50%; margin-left: -50px;`;
            player4.style = `bottom: 50%; left: 0px; margin-top: -50px;`;
            player1.style = `top: 0px; left: 50%; margin-left: -50px;`;
            player2.style = `bottom: 50%; right: 0px; margin-top: -50px;`;
        } else if (playerNumber === 'player4') {
            player4.style = `bottom: 0px; left: 50%; margin-left: -50px;`;
            player1.style = `bottom: 50%; left: 0px; margin-top: -50px;`;
            player2.style = `top: 0px; left: 50%; margin-left: -50px;`;
            player3.style = `bottom: 50%; right: 0px; margin-top: -50px;`;
        }
    });

    socket.on('game_info', game => {

        if(game[playerNumber].ready && game[playerNumber].cards.length === 0)
            socket.emit('no_cards');
        for (let i = 1; i < 5; i++) {
            let player = 'player' + i;
            if (game[player].cards.length !== 0) {
                if (playerNumber === player)
                    document.getElementById(player).innerHTML = printActiveBack();
                else {
                    document.getElementById(player).innerHTML = printCardBack();
                    document.getElementById(player).innerHTML += `
<b style="position: absolute; z-index: 1; top: 3px; left: 3px;">
${game[player].name}<br>${game[player].cards.length}</b>`;
                }
            } else document.getElementById(player).innerHTML = printNoCard();
        }
        //print player info
        player_info.innerHTML = ``;
        if (game[playerNumber].cards.length > 0){
            player_info.innerHTML = `
<h3>${game[playerNumber].cards.length} cards left<br>${game.pile.length} cards in pile</h3>`;
        }
        //place the last played card
        if (game.pile.length > 0) {
            play_pile.innerHTML += printCard(game.pile[game.pile.length - 1], nextPosition());
        }
        //empty turn_text
        turn_text.innerHTML = '';
        //if it is client's turn
        if (game[playerNumber].ready) {
            alertSound.play();
            turn_text.innerHTML = '<h2>your turn</h2>';
            document.getElementById('clickable').addEventListener('click', () => {
                socket.emit('play_card');
            });
        }
    });

    socket.on('rules', table => {
        for (let key in table){
            let p ='player';
            if (!(key === p + 1 || key === p + 2 || key === p + 3 || key === p + 4)) {
                document.getElementById(key + table[key]).checked = true;
            }
        }

    });
    //this changes each time a card is put down
    let position = 1;
    const nextPosition = () => {
        if (position === 1) {
            position = 2;
            return `position: absolute; height: 100px; width: 70px; bottom: 0px; left: 0;`;
        } else if (position === 2) {
            position = 3;
            return `position: absolute; height: 100px; width: 70px; top: 0px; left: 0;`;
        } else if (position === 3) {
            position = 4;
            return `position: absolute; height: 100px; width: 70px; top: 0px; right: 0;`;
        } else if (position === 4) {
            position = 1;
            return `position: absolute; height: 100px; width: 70px; bottom: 0px; right: 0;`;
        }
    };
    const printActiveBack = () =>
        `<img id="clickable" src= "http://owolfhu1.x10host.com/Oh_Hell_solo/img/card_back.png" style="height : 100%;">`;
    const printNoCard = () => `<img src= "http://owolfhu1.x10host.com/Oh_Hell_solo/img/play_area.png" style="height : 100%;">`;
    const printCardBack = () => `<img src= "http://owolfhu1.x10host.com/Oh_Hell_solo/img/card_back.png" style="height : 100%;">`;
    const printCard = (card, position) =>
        `<img src= "http://owolfhu1.x10host.com/Oh_Hell_solo/img/card${card[1]}${card[0]}.png" style="${position}">`;

</script>
</body>
</html>